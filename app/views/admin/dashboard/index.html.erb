<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Admin Dashboard</h1>
    <div>
      <%= link_to 'Update Health', update_system_health_admin_dashboard_path, method: :post, class: 'btn btn-info me-2' %>
      <%= link_to 'Toggle Maintenance', toggle_maintenance_mode_admin_dashboard_path, method: :post, 
          class: "btn #{@maintenance_mode ? 'btn-warning' : 'btn-success'}" %>
    </div>
  </div>

  <!-- System Health -->
  <div class="row g-4 mb-5">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">System Health</h5>
        </div>
        <div class="card-body">
          <% if @system_health.present? %>
            <div class="row">
              <div class="col-6">
                <strong>Status:</strong>
                <span class="badge <%= @system_health['redis_connected'] ? 'bg-success' : 'bg-danger' %>">
                  <%= @system_health['redis_connected'] ? 'Connected' : 'Disconnected' %>
                </span>
              </div>
              <div class="col-6">
                <strong>Database:</strong>
                <span class="badge <%= @system_health['database_connected'] ? 'bg-success' : 'bg-danger' %>">
                  <%= @system_health['database_connected'] ? 'Connected' : 'Disconnected' %>
                </span>
              </div>
            </div>
            <hr>
            <div class="row">
              <div class="col-6">
                <strong>Total Users:</strong> <%= @system_health['total_users'] || 0 %>
              </div>
              <div class="col-6">
                <strong>OAuth Apps:</strong> <%= @system_health['total_oauth_apps'] || 0 %>
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-6">
                <strong>API Requests:</strong> <%= @system_health['total_api_requests'] || 0 %>
              </div>
              <div class="col-6">
                <strong>Maintenance:</strong>
                <span class="badge <%= @system_health['maintenance_mode'] ? 'bg-warning' : 'bg-success' %>">
                  <%= @system_health['maintenance_mode'] ? 'Enabled' : 'Disabled' %>
                </span>
              </div>
            </div>
            <small class="text-muted">
              Last updated: <%= @system_health['timestamp'] ? Time.parse(@system_health['timestamp']).strftime('%Y-%m-%d %H:%M:%S') : 'Never' %>
            </small>
          <% else %>
            <p class="text-muted">No system health data available. Click "Update Health" to refresh.</p>
          <% end %>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Global Statistics</h5>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-4">
              <h3 class="text-primary"><%= @total_stats[:api_requests] %></h3>
              <small class="text-muted">API Requests</small>
            </div>
            <div class="col-4">
              <h3 class="text-success"><%= @total_stats[:oauth_tokens] %></h3>
              <small class="text-muted">OAuth Tokens</small>
            </div>
            <div class="col-4">
              <h3 class="text-info"><%= @total_stats[:users_registered] %></h3>
              <small class="text-muted">Users Registered</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Activities -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Recent Activities</h5>
        </div>
        <div class="card-body">
          <% if @recent_activities.any? %>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>User</th>
                    <th>Action</th>
                    <th>Details</th>
                  </tr>
                </thead>
                <tbody>
                  <% @recent_activities.each do |activity| %>
                    <% activity_data = JSON.parse(activity) rescue {} %>
                    <tr>
                      <td>
                        <small>
                          <%= activity_data['timestamp'] ? Time.parse(activity_data['timestamp']).strftime('%H:%M:%S') : 'N/A' %>
                        </small>
                      </td>
                      <td>
                        <% if activity_data['user_id'] %>
                          <%= link_to "User #{activity_data['user_id']}", oauth_applications_path %>
                        <% else %>
                          <span class="text-muted">Anonymous</span>
                        <% end %>
                      </td>
                      <td>
                        <span class="badge bg-secondary">
                          <%= activity_data['action'] || 'Unknown' %>
                        </span>
                      </td>
                      <td>
                        <small class="text-muted">
                          <%= activity_data['endpoint'] || activity_data['path'] || 'N/A' %>
                        </small>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p class="text-muted">No recent activities recorded.</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
